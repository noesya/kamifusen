<%
# image_tag options
options ||= {}
alt = options[:alt]
width = options[:width]
height = options[:height]
klass = options[:class]
parameters = " loading=\"lazy\" decoding=\"async\""
parameters += " alt=\"#{ options[:alt] }\"" if alt
parameters += " width=\"#{ options[:width] }\"" if width
parameters += " height=\"#{ options[:height]}\"" if height
parameters += " class=\"#{ options[:class] }\"" if klass
%>
<% if source.variable? %>
  <%
  # kamifusen settings
  sizes = [320, 576, 640, 768, 992, 1152, 1200, 1400, 1536, 1984, 2400]
  quality = 80
  # Computing
  if width
    width_retina = width * 2
    sizes.reject! { |size| size > width_retina }
    sizes << width_retina
    sizes.uniq!
  end
  default_width = sizes.max
  default_width = width_retina if width_retina && width_retina > default_width
  if Kamifusen.with_webp
    srcset_webp = sizes.map { |size|
      "#{ url_for source.variant(resize: "#{size}>", format: :webp, quality: quality) } #{ size }w"
    }.join(', ')
  end
  srcset_default = sizes.map { |size|
    "#{ url_for source.variant(resize: "#{size}>", quality: quality) } #{ size }w"
  }.join(', ')
  default = url_for source.variant(resize: "#{default_width}>", quality: quality)
  %>
  <picture>
    <% if Kamifusen.with_webp %>
      <source srcset="<%= srcset_webp %>" type="image/webp">
    <% end %>
    <img src="<%= default %>" srcset="<%= srcset_default %>" type="<%= source.content_type %>"<%= raw parameters %>>
  </picture>
<% else %>
  <picture>
    <img src="<%= url_for source %>" type="<%= source.content_type %>"<%= raw parameters %>>
  </picture>
<% end %>
