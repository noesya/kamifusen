<%
# image_tag options
options ||= {}
alt = options[:alt]
width = options[:width]
height = options[:height]
klass = options[:class]
parameters = " loading=\"lazy\" decoding=\"async\""
parameters += " alt=\"#{ options[:alt] }\"" if alt
parameters += " width=\"#{ options[:width] }\"" if width
parameters += " height=\"#{ options[:height]}\"" if height
parameters += " class=\"#{ options[:class] }\"" if klass
%>
<% if source.variable? %>
  <%
  # kamifusen settings
  sizes = [320, 576, 640, 768, 992, 1152, 1200, 1400, 1536, 1984, 2400]
  quality = 80
  # Computing
  sizes.reject! { |size| size > width * 2 } if width
  srcset_webp = sizes.map { |size| "#{ url_for source.variant(resize: "#{size}>", format: :webp, quality: quality) } #{ size }vw" }.join(', ')
  srcset_default = sizes.map { |size| "#{ url_for source.variant(resize: "#{size}>", quality: quality) } #{ size }vw" }.join(', ')
  default = url_for source.variant(resize: "#{sizes.max}>", quality: quality)
  %>
  <picture>
    <source srcset="<%= srcset_webp %>">
    <img src="<%= default %>" srcset="<%= srcset_default %>"<%= raw parameters %>>
  </picture>
<% else %>
  <picture>
    <img src="<%= url_for source %>"<%= raw parameters %>>
  </picture>
<% end %>
